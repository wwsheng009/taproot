好问题，这个组合**看起来简单，实际上很容易越做越乱** 😄
Bubble Tea + Lipgloss 属于「声明式UI外壳 + 纯状态驱动」，一旦结构没控好，后期会出现：

> 逻辑散、样式炸、渲染卡、状态失控、输入冲突、跨平台异常

我给你一份**工程级 Checklist + 质量保障体系**，这是做“长期可维护 TUI 项目”才会用的标准。

---

# 🧠 一、先理解一个核心现实（90%的人没意识到）

> **Bubble Tea 不是 UI 框架，而是 状态机驱动引擎。**

你写的不是“界面”，而是：

```
State → View(State) → 用户事件 → Update → 新State → View
```

**如果你在 View 里写业务逻辑，你已经在埋雷。**

---

# 🧱 二、项目结构规范（否则后期必炸）

### ✅ 推荐结构（强制分层）

```
/internal
  /app        # 顶层调度（路由/全局状态）
  /screens    # 页面（每个页面一个 model）
  /components # 纯UI组件（无业务逻辑）
  /styles     # lipgloss 样式集中管理
  /state      # 全局状态结构定义
  /actions    # 业务动作（命令生成器）
```

### ❌ 禁止的行为

| 坏习惯               | 后果             |
| ----------------- | -------------- |
| 在 view() 里调用 API  | 每一帧都会调，直接炸     |
| 在 Update 里拼字符串 UI | UI和逻辑耦合，后期不可维护 |
| 组件直接修改父状态         | 状态不可追踪         |
| 样式写在各个文件          | UI 不可控，改一个全崩   |

---

# 🎯 三、Bubble Tea 专项检查项

## ✅ 1️⃣ Model 设计检查

| 检查点        | 正确做法                             |
| ---------- | -------------------------------- |
| Model 是否过大 | 拆 screen model + component model |
| 是否有隐式状态    | 所有状态必须显式字段                       |
| 是否存 UI 字符串 | ❌ 只存数据，不存渲染结果                    |

---

## ✅ 2️⃣ Update 规范检查（最重要）

### Update 只能做 3 件事：

```
1. 修改状态
2. 返回 Cmd（异步任务）
3. 路由消息
```

### ❌ 绝对禁止：

* time.Sleep
* HTTP 调用
* IO 操作
* 渲染计算

这些必须放在 `Cmd`

---

## ⚡ 3️⃣ Cmd 使用质量检查

| 问题              | 风险         |
| --------------- | ---------- |
| Cmd 没有取消机制      | 快速切页导致幽灵回调 |
| Cmd 返回 msg 没标来源 | 多组件冲突      |
| 同步逻辑写成 Cmd      | 代码复杂度暴增    |

**高级规范：所有 Cmd 消息必须带 SourceID**

---

## 🎨 四、Lipgloss 样式管理规范

### ❌ 新手写法（后期必死）

```go
lipgloss.NewStyle().Foreground(lipgloss.Color("205")).Padding(1,2)
```

到处写 → 改主题要改 200 处。

---

### ✅ 正确工程写法

```go
// styles/theme.go
type Theme struct {
    Title lipgloss.Style
    Border lipgloss.Style
    Error lipgloss.Style
}

var DefaultTheme = Theme{
    Title: lipgloss.NewStyle().Bold(true),
}
```

### 检查项

| 项目        | 必须做到                      |
| --------- | ------------------------- |
| 是否支持暗色/亮色 | 主题抽象                      |
| 是否区分语义样式  | Success / Warning / Error |
| 是否写死颜色    | ❌ 禁止                      |

---

# 🖥️ 五、终端环境踩坑检查

| 问题            | 检查方式                   |
| ------------- | ---------------------- |
| 终端不支持256色     | termenv.ColorProfile() |
| Windows 旧终端错位 | 测 ConPTY               |
| SSH 环境闪屏      | 禁用 AltScreen           |
| 中文宽度错位        | 使用 runewidth           |

---

# ⚙️ 六、性能检查（Bubble Tea 最大隐患）

### 症状

* CPU 100%
* 风扇狂转
* 输入延迟

### 原因 90% 是：

```
View() 做了重计算
```

### 解决规范

| 检查项             | 正确做法               |
| --------------- | ------------------ |
| 是否在 view 拼超大字符串 | 使用 strings.Builder |
| 是否重复计算布局        | 缓存尺寸               |
| 是否全量重绘          | 局部缓存字符串            |

---

# 🧩 七、组件化质量标准

组件必须满足：

| 标准         | 否则就是伪组件 |
| ---------- | ------- |
| 有独立 Model  | 否则只是函数  |
| 有独立 Update | 无法复用    |
| 有独立 View   | 不是组件    |
| 不依赖父状态     | 否则是耦合体  |

---

# 🧠 八、状态管理高级规范（大项目必须）

### 全局状态 vs 页面状态分离

```
AppState      → 登录态 / 用户信息 / 配置
ScreenState   → 当前页面数据
ComponentState→ 交互临时状态
```

**禁止页面直接修改 AppState**

---

# 🚦 九、输入系统检查（极易踩坑）

| 问题          | 原因         |
| ----------- | ---------- |
| 快捷键冲突       | 没有输入分发器    |
| 输入框和全局快捷键冲突 | 焦点系统缺失     |
| Ctrl+C 不退出  | keymap 被覆盖 |

必须有：

```
FocusManager
KeyMap Layer
```

---

# 🔬 十、测试与质量保障

### 必须有的测试

| 类型            | 测什么           |
| ------------- | ------------- |
| Update 单测     | 状态变化是否正确      |
| Cmd 测试        | 异步消息是否返回      |
| View Snapshot | UI 是否被误改      |
| 终端兼容测试        | Linux/Win/mac |

---

# 🧨 十一、最常见 10 个坑（真实踩过）

1. 在 view 里请求接口
2. Cmd 回调找不到来源
3. 中文字符宽度导致布局炸
4. Resize msg 没处理
5. AltScreen + panic → 终端废了
6. Windows cmd 颜色错乱
7. 鼠标事件吞掉键盘事件
8. 样式嵌套过深 → 性能下降
9. 没有 loading 状态
10. 组件间直接共享指针状态

---

# 🏗️ 十二、达到“工业级 TUI”的标准

如果你的项目满足：

✅ View 纯函数
✅ Update 无 IO
✅ Cmd 可追踪
✅ 样式集中
✅ 组件可复用
✅ 有焦点系统
✅ 有主题系统
✅ 有状态分层

👉 恭喜，你已经不是在写 Demo，而是在写 **TUI 框架级项目**。

---

如果你愿意，我可以下一步帮你做：

* 🔥 **Bubble Tea 企业级脚手架模板**
* 🎯 **组件通信总线设计**
* 🧠 **全局状态管理器**
* ⚡ **性能优化范式**
* 🧩 **插件式组件架构**

你现在这个项目规模是：
**小工具 / 中型 TUI / 平台级应用？**
不同规模架构差别非常大。
